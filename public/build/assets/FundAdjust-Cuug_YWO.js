import{_ as te,u as le,f as d,D as oe,E as ne,c as n,o as i,b as e,h as k,l as ie,F as M,r as T,i as x,t as l,j as re,v as ce,n as w,w as q,M as de,e as ue}from"./app-BFj7m03g.js";import{A as ve}from"./AdminMobileNav-DI3t1v3n.js";const pe={class:"fund-adjust-screen"},me={class:"floating-particles"},fe={class:"users-section"},_e={key:0,class:"loading-state"},he={key:1,class:"error-state"},ye={key:2,class:"users-grid"},ge=["onClick"],be={class:"user-avatar"},ke=["src","alt","onError"],we={key:1,class:"avatar-fallback"},Ae={class:"user-info"},je={class:"user-id"},Ce={class:"user-name"},Ee={class:"user-email"},Be={class:"user-balance"},Fe={class:"modal-header"},Ue={class:"modal-body"},Ne={class:"user-info-section"},De={class:"user-avatar-large"},Me=["src","alt"],Te={key:1,class:"avatar-fallback-large"},xe={class:"user-details"},$e={class:"user-name"},Re={class:"user-email"},Se={class:"user-id"},Ie={class:"balance-fields"},Le={class:"form-group"},Pe=["value"],Ve={class:"form-group"},ze={key:0,class:"adjustment-preview"},Ge={class:"preview-item"},Ke={class:"preview-item"},Oe={class:"preview-value"},Je={class:"modal-actions"},We=["disabled"],qe={class:"modal-body"},He={key:0,class:"loading-state"},Qe={key:1,class:"no-adjustments"},Xe={key:2,class:"adjustments-list"},Ye={class:"adjustment-header"},Ze={class:"user-info"},es={class:"user-avatar-small"},ss=["src","alt","onError"],as={key:1,class:"avatar-fallback-small"},ts={class:"user-details"},ls={class:"user-name"},os={class:"user-id"},ns={class:"adjustment-details"},is={class:"amount-section"},rs={class:"amount-value"},cs={class:"balance-section"},ds={class:"balance-value"},us={class:"description-section"},vs={class:"description-value"},ps={class:"timestamp-section"},ms={class:"timestamp-value"},fs={key:2,class:"toast-notification"},_s={class:"toast-content"},hs={__name:"FundAdjust",setup(ys){le();const _=d([]),o=d(null),c=d(""),p=d(0),A=d(!1),m=d(!1),h=d(null),j=d([]),C=d(!1),E=d(null),B=d(!1),F=d(!1),$=d(""),U=d(!1),R=oe(()=>{var a;return c.value&&parseFloat(c.value)>=0&&parseFloat(c.value)!==parseFloat(((a=o.value)==null?void 0:a.total_balance)||0)}),H=async()=>{A.value=!0,h.value=null;try{const a=localStorage.getItem("access_token");if(!a)throw new Error("No access token found. Please login again.");const s=await fetch(`${window.location.origin}/api/users`,{method:"GET",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json",Accept:"application/json"}});if(!s.ok)throw new Error("Failed to fetch users");const r=await s.json();if(r.success&&r.data)_.value=r.data.filter(u=>!u.is_admin).map(u=>(console.log(`User ${u.name} profile_image:`,u.profile_image),{...u}));else throw new Error(r.message||"Failed to fetch users")}catch(a){console.error("Error fetching users:",a),h.value=a.message}finally{A.value=!1}},Q=a=>{o.value=a,c.value=a.total_balance||"0.00",p.value=0,C.value=!0,setTimeout(()=>{E.value&&E.value.focus()},100)},X=()=>{if(o.value&&c.value){const a=parseFloat(o.value.total_balance||0),s=parseFloat(c.value);p.value=s-a}},Y=async()=>{if(R.value){m.value=!0;try{const a=localStorage.getItem("access_token");if(!a)throw new Error("No access token found. Please login again.");const s=await fetch(`${window.location.origin}/api/admin/fund-adjust`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({user_id:o.value.id,type:"set",amount:parseFloat(c.value),reason:"Balance adjustment by admin"})});if(!s.ok)throw new Error("Failed to update balance");const r=await s.json();if(r.success){S(`Balance updated successfully! New balance: â‚¹${c.value}`,"success"),o.value.total_balance=parseFloat(c.value);const u=_.value.findIndex(b=>b.id===o.value.id);u!==-1&&(_.value[u].total_balance=parseFloat(c.value)),y(),N()}else throw new Error(r.message||"Failed to update balance")}catch(a){console.error("Error updating balance:",a),S(`Error updating balance: ${a.message}`,"error")}finally{m.value=!1}}},y=()=>{C.value=!1,o.value=null,c.value="",p.value=0},Z=async()=>{B.value=!0,F.value=!0;try{await N()}finally{F.value=!1}},g=()=>{B.value=!1},S=(a,s="success")=>{$.value=a,U.value=!0,setTimeout(()=>{U.value=!1},3e3)},N=async()=>{try{const a=localStorage.getItem("access_token");if(!a)return;const s=await fetch(`${window.location.origin}/api/admin/fund-adjustments`,{method:"GET",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json",Accept:"application/json"}});if(s.ok){const r=await s.json();r.success&&(j.value=r.data||[])}}catch(a){console.error("Error fetching recent adjustments:",a)}},f=a=>{if(console.log("getProfileImageUrl called with:",a),!a||a===""||a===null)return console.log("No valid profile image, returning null"),null;if(a.startsWith("http"))return console.log("Profile image is already a full URL:",a),a;const s=`${window.location.origin}/${a}`;return console.log("Constructed local URL:",s),s},D=(a,s)=>{console.log("Image load error for user:",s),a.target.style.display="none";const r=a.target.nextElementSibling;return r&&(r.style.display="flex"),a.preventDefault(),!1},ee=a=>{switch(a){case"add":return"type-add";case"subtract":return"type-subtract";case"set":return"type-set";default:return""}},se=a=>a?new Date(a).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"N/A";return ne(()=>{H(),N()}),(a,s)=>{var r,u,b,I,L,P,V,z;return i(),n("div",pe,[e("div",me,[(i(),n(M,null,T(20,t=>e("div",{class:"particle",key:t,style:ue({left:Math.random()*100+"%",animationDelay:Math.random()*20+"s",animationDuration:Math.random()*10+10+"s"})},null,4)),64))]),e("div",{class:"page-header"},[s[4]||(s[4]=e("div",{class:"header-content"},[e("h1",{class:"page-title"},"âš–ï¸ Fund Adjust"),e("p",{class:"page-subtitle"},"Adjust user wallet balances and manage funds")],-1)),e("div",{class:"header-actions"},[e("button",{class:"btn-recent-adjustments",onClick:Z}," ðŸ“Š Recent Adjustments ")])]),e("div",fe,[s[7]||(s[7]=e("h3",{class:"section-title"},"Select User to Adjust Balance",-1)),A.value?(i(),n("div",_e,s[5]||(s[5]=[e("i",{class:"fa-solid fa-spinner fa-spin"},null,-1),x(" Loading users... ")]))):h.value?(i(),n("div",he,[s[6]||(s[6]=e("i",{class:"fa-solid fa-exclamation-triangle"},null,-1)),x(" "+l(h.value),1)])):(i(),n("div",ye,[(i(!0),n(M,null,T(_.value,t=>(i(),n("div",{key:t.id,class:w(["user-card",{selected:o.value&&o.value.id===t.id}]),onClick:v=>Q(t)},[e("div",be,[t.profile_photo&&t.profile_photo.trim()!==""&&f(t.profile_photo)?(i(),n("img",{key:0,src:f(t.profile_photo),alt:t.name,onError:v=>D(v,t.name)},null,40,ke)):(i(),n("div",we,l(t.name?t.name.charAt(0).toUpperCase():"ðŸ‘¤"),1))]),e("div",Ae,[e("div",je,"ID: "+l(t.id),1),e("h4",Ce,l(t.name),1),e("p",Ee,l(t.email),1),e("div",Be,"â‚¹"+l(t.total_balance||"0.00"),1)])],10,ge))),128))]))]),C.value?(i(),n("div",{key:0,class:"modal-overlay",onClick:y},[e("div",{class:"modal-content",onClick:s[2]||(s[2]=q(()=>{},["stop"]))},[e("div",Fe,[e("h3",null,"Update Balance - "+l((r=o.value)==null?void 0:r.name),1),e("button",{class:"close-btn",onClick:y},"Ã—")]),e("div",Ue,[e("div",Ne,[e("div",De,[(u=o.value)!=null&&u.profile_photo&&o.value.profile_photo.trim()!==""&&f(o.value.profile_photo)?(i(),n("img",{key:0,src:f(o.value.profile_photo),alt:(b=o.value)==null?void 0:b.name,onError:s[0]||(s[0]=t=>{var v;return D(t,(v=o.value)==null?void 0:v.name)})},null,40,Me)):(i(),n("div",Te,l((I=o.value)!=null&&I.name?o.value.name.charAt(0).toUpperCase():"ðŸ‘¤"),1))]),e("div",xe,[e("h4",$e,l((L=o.value)==null?void 0:L.name),1),e("p",Re,l((P=o.value)==null?void 0:P.email),1),e("p",Se,"ID: "+l((V=o.value)==null?void 0:V.id),1)])]),e("div",Ie,[e("div",Le,[s[8]||(s[8]=e("label",{class:"form-label"},"Current Balance (Locked)",-1)),e("input",{type:"text",value:((z=o.value)==null?void 0:z.total_balance)||"0.00",class:"form-input locked-field",readonly:"",disabled:""},null,8,Pe),s[9]||(s[9]=e("small",{class:"field-note"},"This field cannot be changed",-1))]),e("div",Ve,[s[10]||(s[10]=e("label",{class:"form-label"},"Updated Balance (â‚¹)",-1)),re(e("input",{type:"number","onUpdate:modelValue":s[1]||(s[1]=t=>c.value=t),class:"form-input",placeholder:"Enter new balance amount",min:"0",step:"0.01",onInput:X,ref_key:"balanceInput",ref:E},null,544),[[ce,c.value]]),s[11]||(s[11]=e("small",{class:"field-note"},"Enter the new balance amount",-1))])]),p.value!==0?(i(),n("div",ze,[e("div",Ge,[s[12]||(s[12]=e("span",{class:"preview-label"},"Adjustment Amount:",-1)),e("span",{class:w(["preview-value",p.value>0?"positive":"negative"])},l(p.value>0?"+":"")+"â‚¹"+l(Math.abs(p.value).toFixed(2)),3)]),e("div",Ke,[s[13]||(s[13]=e("span",{class:"preview-label"},"New Balance:",-1)),e("span",Oe,"â‚¹"+l(c.value||"0.00"),1)])])):k("",!0)]),e("div",Je,[e("button",{class:"btn-secondary",onClick:y},"Cancel"),e("button",{class:"btn-primary",onClick:Y,disabled:!R.value||m.value},[e("i",{class:w(["fa-solid fa-check",{"fa-spin":m.value}])},null,2),x(" "+l(m.value?"Updating...":"Update Balance"),1)],8,We)])])])):k("",!0),B.value?(i(),n("div",{key:1,class:"modal-overlay",onClick:g,onKeydown:de(g,["esc"])},[e("div",{class:"modal-content recent-adjustments-modal",onClick:s[3]||(s[3]=q(()=>{},["stop"]))},[e("div",{class:"modal-header"},[s[14]||(s[14]=e("h3",null,"ðŸ“Š Recent Adjustments",-1)),e("button",{class:"close-btn",onClick:g},"Ã—")]),e("div",qe,[F.value?(i(),n("div",He,s[15]||(s[15]=[e("i",{class:"fa-solid fa-spinner fa-spin"},null,-1),e("p",null,"Loading recent adjustments...",-1)]))):j.value.length===0?(i(),n("div",Qe,s[16]||(s[16]=[e("i",{class:"fa-solid fa-info-circle"},null,-1),e("p",null,"No recent adjustments found",-1)]))):(i(),n("div",Xe,[(i(!0),n(M,null,T(j.value,t=>{var v,G,K,O,J;return i(),n("div",{key:t.id,class:"adjustment-item"},[e("div",Ye,[e("div",Ze,[e("div",es,[(v=t.user)!=null&&v.profile_photo&&t.user.profile_photo.trim()!==""?(i(),n("img",{key:0,src:f(t.user.profile_photo),alt:(G=t.user)==null?void 0:G.name,onError:ae=>{var W;return D(ae,(W=t.user)==null?void 0:W.name)}},null,40,ss)):(i(),n("div",as,l((K=t.user)!=null&&K.name?t.user.name.charAt(0).toUpperCase():"ðŸ‘¤"),1))]),e("div",ts,[e("h4",ls,l(((O=t.user)==null?void 0:O.name)||"Unknown User"),1),e("p",os,"ID: "+l(((J=t.user)==null?void 0:J.id)||"N/A"),1)])]),e("div",{class:w(["adjustment-type",ee(t.adjustment_type)])},l(t.adjustment_type==="add"?"+":t.adjustment_type==="subtract"?"-":"Set"),3)]),e("div",ns,[e("div",is,[s[17]||(s[17]=e("span",{class:"amount-label"},"Amount:",-1)),e("span",rs,"â‚¹"+l(t.amount),1)]),e("div",cs,[s[18]||(s[18]=e("span",{class:"balance-label"},"New Balance:",-1)),e("span",ds,"â‚¹"+l(t.running_balance),1)]),e("div",us,[s[19]||(s[19]=e("span",{class:"description-label"},"Description:",-1)),e("span",vs,l(t.description||"Balance adjustment by admin"),1)]),e("div",ps,[s[20]||(s[20]=e("span",{class:"timestamp-label"},"Date:",-1)),e("span",ms,l(se(t.created_at)),1)])])])}),128))]))]),e("div",{class:"modal-footer"},[e("button",{class:"btn-secondary",onClick:g}," Close ")])])],32)):k("",!0),U.value?(i(),n("div",fs,[e("div",_s,[s[21]||(s[21]=e("i",{class:"fa-solid fa-check-circle"},null,-1)),e("span",null,l($.value),1)])])):k("",!0),ie(ve)])}}},ks=te(hs,[["__scopeId","data-v-d2c7169c"]]);export{ks as default};
